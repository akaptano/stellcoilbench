# StellCoilBench Workflow Guide

## Overview

This repository uses two main directories:

- **`cases/`** - Benchmark case definitions (input)
- **`submissions/`** - Submission results (output, generated)

## Directory Structure

```
stellcoilbench/
├── cases/                    # Benchmark case definitions
│   ├── case.yaml            # Example case definition
│   └── README.md
├── submissions/              # Generated submission results
│   ├── input.LandremanPaul2021_QA/  # Plasma surface name
│   │   └── akaptano/         # GitHub username
│   │       └── 12-20-2024_14-30/  # Date and time (MM-DD-YYYY_HH-MM)
│   │           ├── results.json  # Generated by submit-case command
│   │           ├── case.yaml     # Copy of case.yaml used for this submission
│   │           ├── coils.json    # Optimized coil geometry
│   │           └── *.vtu, *.vts  # VTK visualization files
│   └── README.md
├── db/                       # Generated reference files (on leaderboard branch only)
│   └── leaderboard.json      # Optional reference file
└── docs/                     # Generated leaderboards (on leaderboard branch only)
    ├── leaderboard.md
    └── ...
```

## How to Add a Submission

### Step 1: Define a Case (if needed)

Create or use an existing `case.yaml` file in `cases/`:

```yaml
# cases/my_case.yaml
case_id: "my_benchmark_case"
description: "My optimization test"
surface_params:
  nphi: 32
  ntheta: 32
  surface: "input.LandremanPaul2021_QA"
  range: "half period"
coils_params:
  ncoils: 4
  order: 16
  nturns: 200
  target_B: 1.0
optimizer_params:
  algorithm: "l-bfgs"
  max_iterations: 200
```

### Step 2: Run and Submit

Run the case to generate a submission:

```bash
stellcoilbench submit-case cases/my_case.yaml
```

**What this does:**
1. Runs the coil optimization for the case
2. Evaluates the results
3. Auto-detects GitHub username and hardware
4. Generates `submissions/<surface>/<github_username>/<MM-DD-YYYY_HH-MM>/results.json`
5. Saves `coils.json` (optimized coil geometry) in the submission directory
6. Copies `case.yaml` to the submission directory for reference
7. Saves VTK visualization files (*.vtu, *.vts) in the submission directory

**Directory naming:**
- Username: Auto-detected from git config (or use `--contact` to override)
- Timestamp: Current date and time in `MM-DD-YYYY_HH-MM` format (e.g., `12-20-2024_14-30`)

**Optional flags:**
- `--contact` - Override auto-detected contact (default: GitHub username)
- `--hardware` - Override auto-detected hardware (default: auto-detected CPU/GPU)
- `--notes` - Add notes about the submission

### Step 3: Commit and Push

Commit the generated `results.json` file:

```bash
git add submissions/my_optimization_method/v1.0.0/results.json
git commit -m "Add submission: my_optimization_method v1.0.0"
git push
```

### Step 4: CI Updates Leaderboard

When you push to `main`, CI automatically:
1. Commits your submission to the `main` branch
2. Scans `submissions/` for all `results.json` files
3. Builds `db/` database files
4. Generates `docs/leaderboard.md` and related files
5. Commits the leaderboard files to the `leaderboard` branch (separate from `main`)

**Important**: You don't need to pull leaderboard files - they're on a separate branch. Your `main` branch stays clean!

## How It Works

### `cases/` Directory
- **Purpose**: Defines benchmark cases (problem specifications)
- **Format**: YAML files with case configuration
- **Usage**: Input to `submit-case` command
- **Git**: Tracked in git (part of the benchmark definition)

### `submissions/` Directory  
- **Purpose**: Stores submission results (solution outputs)
- **Format**: `results.json` files organized by method/version
- **Usage**: Scanned by `update-db` to build leaderboard
- **Git**: Tracked in git (submissions are part of the repo)

### Generated Files (`db/`, `docs/`)
- **Purpose**: Aggregated database and leaderboards
- **Format**: JSON (db/) and Markdown (docs/)
- **Usage**: Displayed on GitHub (browse the `leaderboard` branch)
- **Git**: Committed to `leaderboard` branch (not on `main` branch)
- **Note**: You don't need to pull these files - they're on a separate branch

## Example Workflow

```bash
# 1. Create a case (or use existing)
cp cases/case.yaml cases/my_test_case.yaml
# Edit my_test_case.yaml as needed

# 2. Run and submit
stellcoilbench submit-case cases/my_test_case.yaml

# 3. Check the generated submission (directory name will be your username + timestamp)
ls submissions/$(git config user.name)/
cat submissions/$(git config user.name)/*/results.json

# 4. Commit and push
git add submissions/
git commit -m "Add submission"
git push

# 5. CI will update the leaderboard automatically
```

## Key Points

- **Cases** (`cases/`) = Problem definitions (what to optimize)
- **Submissions** (`submissions/`) = Results (your solutions) - committed to `main` branch
- **Leaderboard files** (`docs/`, `db/`) = Generated leaderboards - committed to `leaderboard` branch
- **Put submissions in `submissions/`** - either:
  - Generate them with `submit-case` command (recommended)
  - Or manually create `results.json` files following the format
- **CI scans `submissions/`** to build the leaderboard on the `leaderboard` branch
- **Each submission** = one `results.json` file in `submissions/<username>/<MM-DD-YYYY_HH-MM>/`
- **You don't need to pull leaderboard files** - they're on a separate branch, so `main` stays clean!

## Viewing the Leaderboard

The leaderboard is automatically updated on the `leaderboard` branch:
- Browse: `https://github.com/<your-repo>/tree/leaderboard/docs/leaderboard.md`
- Or switch to the `leaderboard` branch locally: `git checkout leaderboard`

