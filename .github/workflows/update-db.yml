# .github/workflows/update-db.yml
name: Update StellCoilBench Database

on:
  push:
    branches: [ main ]

jobs:
  update-db:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper branch operations
          token: ${{ secrets.GITHUB_TOKEN }}  # Explicit token for write access

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install package
        run: |
          pip install -e .

      - name: Run benchmark cases
        run: |
          # Run all .yaml files in cases/ directory and generate submissions
          # Directory will be: submissions/<surface>/<GITHUB_ACTOR>/<MM-DD-YYYY_HH-MM>/
          echo "GITHUB_ACTOR: $GITHUB_ACTOR"
          echo "Finding benchmark cases..."
          
          # Find all .yaml files in cases/ (excluding README.md)
          CASE_FILES=$(find cases -name "*.yaml" -type f | sort)
          
          if [ -z "$CASE_FILES" ]; then
            echo "ERROR: No .yaml files found in cases/ directory!"
            exit 1
          fi
          
          echo "Found benchmark cases:"
          echo "$CASE_FILES"
          
          # Run each case
          FAILED_CASES=()
          SKIPPED_CASES=()
          for case_file in $CASE_FILES; do
            echo ""
            echo "=========================================="
            echo "Running case: $case_file"
            echo "=========================================="
            
            # Check if surface file exists (basic check)
            # Extract surface name from case.yaml
            SURFACE_NAME=$(grep -A 2 "surface_params:" "$case_file" | grep "surface:" | awk '{print $2}' | tr -d '"')
            if [ -n "$SURFACE_NAME" ]; then
              # Check if surface file exists in plasma_surfaces
              if [ ! -f "plasma_surfaces/$SURFACE_NAME" ] && [ ! -f "plasma_surfaces/${SURFACE_NAME,,}" ]; then
                echo "WARNING: Surface file '$SURFACE_NAME' not found in plasma_surfaces/"
                echo "Skipping case: $case_file"
                SKIPPED_CASES+=("$case_file (missing surface: $SURFACE_NAME)")
                continue
              fi
            fi
            
            # Run with error handling
            # Contact and hardware are now auto-detected (no flags needed)
            if ! stellcoilbench submit-case "$case_file"; then
              echo "ERROR: submit-case failed for $case_file!"
              FAILED_CASES+=("$case_file")
            else
              echo "âœ“ Successfully completed $case_file"
            fi
          done
          
          # Report skipped cases
          if [ ${#SKIPPED_CASES[@]} -gt 0 ]; then
            echo ""
            echo "WARNING: The following cases were skipped:"
            for case in "${SKIPPED_CASES[@]}"; do
              echo "  - $case"
            done
          fi
          
          # Check if any cases failed
          if [ ${#FAILED_CASES[@]} -gt 0 ]; then
            echo ""
            echo "ERROR: The following cases failed:"
            for case in "${FAILED_CASES[@]}"; do
              echo "  - $case"
            done
            exit 1
          fi
          
          echo ""
          echo "Checking generated submissions..."
          SUBMISSION_COUNT=$(find submissions -name "results.json" -type f | wc -l)
          echo "Total submissions generated: $SUBMISSION_COUNT"
          
          if [ "$SUBMISSION_COUNT" -eq 0 ]; then
            echo "ERROR: No results.json files were generated!"
            exit 1
          fi
          
          echo "Submission files:"
          find submissions -name "results.json" -type f
          find submissions -type f \( -name "*.json" -o -name "*.yaml" -o -name "*.vtu" -o -name "*.vts" \) | head -20

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "$GITHUB_ACTOR"

      - name: Commit submissions to main
        run: |
          # List what was generated
          echo "Checking for generated submissions..."
          find submissions -type f \( -name "*.json" -o -name "*.yaml" \) 2>/dev/null | head -10 || echo "No submission files found"
          
          # Show git status before adding
          echo "Git status before adding:"
          git status --short submissions/ | head -20 || echo "No changes in submissions/"
          
          # Add submission files
          echo "Adding submission files..."
          git add submissions/ || echo "git add failed"
          
          # Show what's staged
          echo "Staged files:"
          git diff --staged --name-only | head -20 || echo "No staged files"
          
          # Show git status after adding
          echo "Git status after adding:"
          git status --short | head -20
          
          # Commit submissions to main branch
          if ! git diff --staged --quiet; then
            echo "Committing submissions..."
            git commit -m "chore: add CI-generated submission" || (echo "Commit failed" && exit 1)
            echo "Pushing to main..."
            git push origin main || (echo "ERROR: Failed to push to main" && git push origin main --verbose && exit 1)
            echo "Successfully pushed submissions to main"
          else
            echo "WARNING: No new submissions to commit"
            echo "This might mean:"
            echo "  1. Files are already committed"
            echo "  2. Files are being ignored"
            echo "  3. No files were generated"
            # Show what git sees
            echo "Files in submissions/:"
            find submissions -type f | head -10
            echo "Git status of submissions/:"
            git status submissions/ || echo "No status"
          fi
          
          # Verify submissions still exist after commit
          echo "Submissions after commit:"
          find submissions -name "results.json" -type f | head -10 || echo "No submissions found"

      - name: Commit leaderboard files to separate branch
        run: |
          # Fetch all branches to get latest state (including the push we just made)
          echo "Fetching all branches..."
          git fetch origin --prune
          
          # Ensure we're on main and have latest
          git checkout main
          git pull origin main || echo "Already up to date"
          
          # Count submissions on main
          SUBMISSIONS_COUNT=$(find submissions -name "results.json" -type f 2>/dev/null | wc -l)
          echo "Submissions on main: $SUBMISSIONS_COUNT"
          find submissions -name "results.json" -type f | head -5 || echo "No submissions found"
          
          # Create or checkout leaderboard branch, ensuring it has latest submissions from main
          if git show-ref --verify --quiet refs/remotes/origin/leaderboard; then
            # Branch exists remotely, checkout it
            echo "Leaderboard branch exists, checking out..."
            git checkout -b leaderboard origin/leaderboard 2>/dev/null || (git checkout leaderboard && git pull origin leaderboard)
            # Merge main to get latest submissions (use theirs strategy to prefer main's submissions)
            echo "Merging main into leaderboard..."
            git merge origin/main --no-edit -X theirs || git merge main --no-edit -X theirs || echo "Merge completed or no changes"
          else
            # Branch doesn't exist, create it from main (which has all submissions)
            echo "Creating new leaderboard branch from main..."
            git checkout -b leaderboard main
          fi
          
          # Show current branch
          echo "Current branch: $(git branch --show-current)"
          
          # Verify submissions are available after checkout/merge
          echo "Checking for submissions after branch switch..."
          find submissions -name "results.json" -type f | head -10 || echo "No submissions found"
          SUBMISSIONS_AFTER=$(find submissions -name "results.json" -type f 2>/dev/null | wc -l)
          echo "Submissions after checkout: $SUBMISSIONS_AFTER"
          
          # If submissions are missing, checkout them from main
          if [ "$SUBMISSIONS_AFTER" -eq 0 ] && [ "$SUBMISSIONS_COUNT" -gt 0 ]; then
            echo "Submissions missing after checkout, restoring from main..."
            git checkout origin/main -- submissions/ || git checkout main -- submissions/ || echo "Failed to restore submissions"
            # Verify they're restored
            SUBMISSIONS_RESTORED=$(find submissions -name "results.json" -type f 2>/dev/null | wc -l)
            echo "Submissions after restore: $SUBMISSIONS_RESTORED"
          fi
          
          # Generate leaderboard files (now we have all submissions from main)
          stellcoilbench update-db
          
          # Verify files were generated
          echo "Checking generated files..."
          ls -la docs/ 2>/dev/null || echo "docs/ directory not found"
          ls -la docs/*.md 2>/dev/null | head -5 || echo "No markdown files in docs/"
          
          # Force-add generated leaderboard files (ignored by .gitignore)
          # Note: db/leaderboard.json is optional reference, methods.json and cases.json are not saved
          echo "Adding leaderboard files..."
          ADDED_ANY=false
          
          # Add individual files if they exist
          for file in db/leaderboard.json docs/leaderboard.md docs/surfaces.md; do
            if [ -f "$file" ]; then
              echo "Adding $file"
              git add -f "$file" && ADDED_ANY=true
            else
              echo "File not found: $file"
            fi
          done
          
          # Add leaderboard directories if they exist
          if [ -d "docs/leaderboards" ] && [ "$(ls -A docs/leaderboards/*.md 2>/dev/null)" ]; then
            echo "Adding docs/leaderboards/*.md"
            git add -f docs/leaderboards/*.md && ADDED_ANY=true
          fi
          if [ -d "docs/surfaces" ] && [ "$(ls -A docs/surfaces/*.md 2>/dev/null)" ]; then
            echo "Adding docs/surfaces/*.md"
            git add -f docs/surfaces/*.md && ADDED_ANY=true
          fi
          
          # Remove old leaderboards.md if it exists (now combined into leaderboard.md)
          if [ -f "docs/leaderboards.md" ]; then
            echo "Removing old docs/leaderboards.md"
            git rm -f docs/leaderboards.md
          fi
          
          echo "Files added: $ADDED_ANY"
          
          # Show git status before committing
          echo "Git status before commit:"
          git status --short | head -20
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            echo "Committing leaderboard files..."
            git commit -m "chore: update StellCoilBench leaderboard" || echo "Commit failed"
            echo "Attempting to push to leaderboard branch..."
            # Set upstream if branch doesn't exist remotely
            if git show-ref --verify --quiet refs/remotes/origin/leaderboard; then
              git push origin leaderboard || (echo "ERROR: Failed to push" && exit 1)
            else
              git push -u origin leaderboard || (echo "ERROR: Failed to push new branch" && exit 1)
            fi
            echo "Successfully pushed leaderboard to leaderboard branch"
          else
            echo "No leaderboard changes to commit"
            echo "Staged files:"
            git diff --staged --name-only || echo "No staged files"
            echo "Untracked/modified files:"
            git status --short | grep -E "(docs/|db/)" | head -10 || echo "No leaderboard files found"
            echo "All untracked files:"
            git status --untracked-files=all --short | head -10
          fi

